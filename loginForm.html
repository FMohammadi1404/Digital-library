<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width,
            initial-scale=1.0">
            <title>Bootstrap5 Sidebar</title>
        <link href=
        "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" 
        rel="stylesheet"
        integrity=
        "sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" 
        crossorigin="anonymous">
        <link rel="stylesheet" 
        href="style.css">
        <link rel="stylesheet" href=
        "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity=
        "sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" 
        referrerpolicy="no-referrer" />
        
        <!-- chart js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
        
    </head>
    
    <body class="bg-info" dir="rtl" style="font-family: b yekan;">
        
        <script>
            // این متغیر برای محاسبه زمان ماندگاری کاربر در سیستم تعریف شده است
            var totalDuration = 0;

            //description: دریافت آرایه سراسری کاربران و قرار دادن در یک آرایه برای دسترسی در این صفحه
            var users = JSON.parse(localStorage.getItem('globalUsers'));

            //description: دریافت آرایه سراسری کاربر لاگین شده و قرار دادن در یک آرایه برای دسترسی در این صفحه
            var loginUser = JSON.parse(localStorage.getItem('globalLoginUser'));
                
            //description: در شرط زیر بررسی می شود که اگر کاربر در حالت لاگین قرار داشت اگر صفحه ی ورود را باز کرد، صفحه ورود برای کاربر نمایش داده نشود و به صفحه اصلی ریدایرکت شود
            if(loginUser[0] != null){
                // description: کد زیر آرایه ی آخرین کاربر ثبت نام کرده یا وارد شده را در یک آرایه سراسری کپی می کند
                localStorage.setItem('globalLoginUser', JSON.stringify(loginUser));
                window.location.href = "./home.html";
                window.return(null);  // description: این خط برای جلوگیری از اجرای ادامه کد این صفحه بعد از ریدایرکت به صفحه اصلی نوشته شده است
            }

        </script>
                                    
        <div class="container" align="center" style="height: 68vh;">
            
            <div class="row justify-content-center">
                <div class="col-12 col-sm-12 col-md-10 col-lg-9 col-xl-9">
                    <div onsubmit="register(event)" action = "home.html" class="login-box login-css bg-white rounded-2 mt-5" style="padding-top: 0%; padding-bottom: 8%;">
                        <div class="row justify-content-center pb-5 pt-2">
                            <div class="col-md-6 text-center" style="margin-top:8%">
                                <h2 class="heading-section hLogin text-info" style="font-weight: bolder;">ورود به کتابخانه</h2>
                            </div>
                        </div>
                        <form name="loginform" method="post" class="login">
                            <div class="form-group">
                                <input type="text" placeholder="نام کاربری" name="username" id="username" class="form-control css-input" required />
                                <!-- bottom line for validate: -->
                                <div id="usernameError" class = "text-danger"></div>
                            </div>
                            <div class="form-group">
                                <input type="password" placeholder="رمز ورود" name="password" id="password" class="form-control css-input" required />
                                <!-- bottom line for validate: -->
                                <div id="passwordError" class = "text-danger"></div>
                            </div>

                            <div class="form-group">
                                <button id = "register" type = "submit" value = "register" class="css-btn btn btn-primary" onclick="login(event)">ورود</button>
                            </div>

                            <!-- remember me -->
                            <div class="form-group">
                                <label for="rememberme" class="remember text-black m-4">
                                    <input type="checkbox" name="rememberme" id="rememberme" class="checkbox-wrap" />
                                    مرا به خاطر بسپار
                                </label>
                            </div>

                            <!-- sign up -->
                            <div class="form-group">
                                <p class="remember text-black">هنوز ثبت نام نکرده اید؟ &nbsp<a href="registerForm.html">ثبت نام</a></p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
        <script>
            
            // description: تابع ثبت نام کاربران در آرایه ی کاربران                
            function login(event){
                event.preventDefault(); //description: این دستور برای این استفاده شده که با زدن دکمه، فرم ارسال نشود و دستورات داخل این تابع اجرا شود
                //قرار دادن المان های فرم ثبت نام در متغیر برای دسترسی در جاوااسکریپت
                const inputUsername = document.getElementById("username");
                const inputPassword = document.getElementById("password");
                
                //قرار دادن دیوهای نمایش خطا در متغیر برای دسترسی در جاوااسکریپت
                const usernameError = document.getElementById("usernameError");
                const passwordError = document.getElementById("passwordError");
                    
                //پاک کردن محتوای قبلی تگ های دیو نمایش دهنده خطاهای ورودی در هر بار اجرای تابع ثبت نام 
                usernameError.textContent = "";
                passwordError.textContent = ""; 

                let errorState = false;
                // description: شرط های بررسی خطاهای ورودی در فیلد نام کاربری
                if(checkQuotes(inputUsername.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ابتدا و انتهای ورودی نباید کاراکتر" + ' " ' + "وجود داشته باشد!";
                    usernameError.appendChild(errorText); 
                    errorState = true; 
                }
                if(hasBackslash(inputUsername.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ورودی نباید از کاراکتر" + " \\ " + "استفاده شود!";
                    usernameError.appendChild(errorText); 
                    errorState = true; 
                }
                if(containsHTML(inputUsername.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ورودی نباید از کدهای HTML استفاده شود!";
                    usernameError.appendChild(errorText); 
                    errorState = true; 
                }

                // description: شرط های بررسی خطاهای ورودی در فیلد رمز ورود
                if(checkQuotes(inputPassword.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ابتدا و انتهای ورودی نباید کاراکتر" + ' " ' + "وجود داشته باشد!";
                    passwordError.appendChild(errorText); 
                    errorState = true; 
                }
                else if(hasBackslash(inputPassword.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ورودی نباید از کاراکتر" + " \\ " + "استفاده شود!";
                    passwordError.appendChild(errorText); 
                    errorState = true; 
                }
                else if(containsHTML(inputPassword.value)){
                    var errorText = document.createElement("p");
                    errorText.textContent = "در ورودی نباید از کدهای HTML استفاده شود!";
                    passwordError.appendChild(errorText); 
                    errorState = true; 
                }

                if(errorState == false){
                    let findeUserState = false; // description: این متغیر وضعیت پیدا شدن یا نشدن کاربر را مشخص می کند
                    let i = 0;
                    while(users[i]){
                        if(inputUsername.value == users[i].username){
                            findeUserState = true;
                            if(inputPassword.value == users[i].password){
                                const rememberUserCheckbox = document.getElementById("rememberme");
                                if(rememberUserCheckbox.checked == true){
                                    loginUser.length = 0; //description: محتوای آرایه آخرین کاربر وارد شده یا ثبت نام کرده را پاک می کند
                                    loginUser.push({"username": inputUsername.value, "rememberme": true});
                                }
                                else{
                                    loginUser.length = 0; //description: محتوای آرایه آخرین کاربر وارد شده یا ثبت نام کرده را پاک می کند
                                    loginUser.push({"username": inputUsername.value, "rememberme": false}); 
                                    totalDuration = 0; // این متغیر برای محاسبه زمان ماندگاری کاربر در سیستم استفاده می شود
                                    localStorage.setItem('totalDuration', JSON.stringify(totalDuration));                               
                                }
                                // description: کد زیر آرایه ی آخرین کاربر ثبت نام کرده یا وارد شده را در یک آرایه سراسری کپی می کند
                                localStorage.setItem('globalLoginUser', JSON.stringify(loginUser));
                                window.location.href = "./home.html";
                            }
                            else{
                                var errorText = document.createElement("p");
                                errorText.textContent = "رمز ورود اشتباه است!";
                                passwordError.appendChild(errorText); 
                                break;
                            }
                        }
                        i += 1;
                    }
                    if(findeUserState == false){
                        var errorText = document.createElement("p");
                        errorText.textContent = "نام کاربری وارد شده اشتباه است!";
                        usernameError.appendChild(errorText); 
                    }
                }
            }



            // description: توابع بررسی ورودی ها از لحاظ امنیتی
            // description: تابع بررسی وجود کاراکتر " در اول و آخر ورودی
            function checkQuotes(input) {
                return input.startsWith('"') && input.endsWith('"');
            }

            //description: تابع بررسی وجود کاراکتر \ در ورودی
            function hasBackslash(input) {
                let backslashPattern = /\\/;
                return backslashPattern.test(input);
            }

            // description: تابع بررسی وجود کدهای اچ تی ام ال در ورودی
            function containsHTML(input) {
                // الگوی ساده برای تشخیص تگ‌های اچ تی ام ال
                let htmlPattern = /<[^>]*>/;
                return htmlPattern.test(input);
            }

        </script>
    </body>
</html>
